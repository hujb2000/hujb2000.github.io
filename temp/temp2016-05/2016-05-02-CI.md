---
---
layout: post
title:  "CI"
date:   2016-05-02 13:35:30
categories: allen.hu update
---

# Jenkins + Node.js持续集成

什么是持续集成？(Continuous Integration)

提出者Martin Fowler本人对持续集成是这样定义的:持续集成是一种软件开发实践，即团队开发成员经常集成他们的工作，通常每个成员每天至少集成一次，也就意味着每天可能会发生多次集成。每次集成都通过自动化的构建（包括编译，发布，自动化测试)来验证，从而尽快地发现集成错误。许多团队发现这个过程可以大大减少集成的问题，让团队能够更快的开发内聚的软件。

* 持续集成的核心价值在于：
1. 减少风险，减少重复过程
2. 任何时间、任何地点生成可部署的软件
3. 增强项目的可见性
4. 建立团队对开发产品的信心

* 持续集成的原则
1. 所有的开发人员需要在本地机器上做本地构建，然后再提交的版本控制库中，从而确保他们的变更不会导致持续集成失败。
2. 开发人员每天至少向版本控制库中提交一次代码。
3. 开发人员每天至少需要从版本控制库中更新一次代码到本地机器。
4. 需要有专门的集成服务器来执行集成构建,每天要执行多次构建。
5. 每次构建都要100%通过。
6. 每次构建都可以生成可发布的产品。
7. 修复失败的构建是优先级最高的事情。
8. 测试是未来，未来是测试


[Jenkins](https://jenkins.io/index.html)

Jenkins 是一个开源项目，提供了一种易于使用的持续集成系统，使开发者从繁杂的集成中解脱出来，专注于更为重要的业务逻辑实现上。同时 Jenkins 能实施监控集成中存在的错误，提供详细的日志文件和提醒功能，还能用图表的形式形象地展示项目构建的趋势和稳定性。


docker run -p 8080:8080 -p 50000:50000 -v /your/home:/var/jenkins_home jenkins

mkdir data
cat > data/log.properties <<EOF
handlers=java.util.logging.ConsoleHandler
jenkins.level=FINEST
java.util.logging.ConsoleHandler.level=FINEST
EOF


docker run --name myjenkins -u root -p 8080:8080 -p 50000:50000 --env JAVA_OPTS="-Djava.util.logging.config.file=/var/jenkins_home/log.properties" -v `pwd`:/var/jenkins_home jenkins

docker  反尔不太方便，改用直接部署

##

java -jar jenkins.war

/home/hjb/.jenkins/secrets/initialAdminPassword 设置初始密码

Create First Admin User
Username: hjb
password: jenkins
FullName: hujb
Email: hujb2000@163.com

# [杭研CI](http://ci.hz.netease.com)

## 权限配置

Jenkins采用OpenID+项目矩阵授权策略的安全方式，即采用OpenID登录，具体访问和操作任务需要再次授权。

在目前的Jenkins中有以下4种角色：

系统管理员 - 对Jenkins的有完全权限
匿名用户 - 所有来自网易OpenID的用户具有全局读，视图/任务读的权限
QA管理员 - 拥有全局读权限、节点/视图/任务的增删查改操作，QA管理员由系统管理员添加
普通用户 - 初始普通用户只有匿名用户的权限，经QA管理员添加后，对Jenkins的任务有访问或操作权限
当前的超级管理员为陈仕彬<hzchenshibin@corp.netease.com>和井诚<hzjingcheng@corp.netease.com>

Jenkin维护

## CI项目

EagleEye
1. 录制回放


# Jekins 踩过的坑

Jenkins2.1.war包

/home/hjb/.jenkins/secrets/initialAdminPassword 设置初始密码

Create First Admin User
Username: hjb
password: jenkins
FullName: hujb
Email: hujb2000@163.com

Git:
Shell:
export BUILD_ID=dontKillMe
npm install
cd plugins
webpack --config webpack.prod.config.js
cd ../bin
CONFIG_URL='http://static.hzspeed.cn/abc/configicpfc.json'  ENV=TEST  nohup babel-node --harmony main.js --debug-output=true --http.server.port=8899 --src-dirs=src --main-class=netease.icp.backend.Main --config-files=config/service.conf  --easynode.app.id=icp &
echo $?
#npm test

OLD_BUILD_ID=$BUILD_ID
echo $OLD_BUILD_ID
BUILD_ID=dontKillMe

/home/hjb/scripts/killport.sh 8899
npm install
cd plugins
webpack --config webpack.prod.config.js
cd ../bin
CONFIG_URL='http://static.hzspeed.cn/abc/configicpfc.json'  ENV=TEST  nohup babel-node --harmony main.js --debug-output=true --http.server.port=8899 --src-dirs=src --main-class=netease.icp.backend.Main --config-files=config/service.conf  --easynode.app.id=icp &
echo $?
docker build -t hub.c.163.com/hujb2000/icp:0.0.33 .
docker push hub.c.163.com/hujb2000/icp:0.0.33
sh start.sh 0.0.33
echo $?

BUILD_ID=$OLD_BUILD_ID
echo $BUILD_ID

#npm test
#echo $?
#Build API DOC
#cd plugins/apidoc
#sh apidoc.sh

babel-node 加入 &，进程当Job完成时退出，没有加&时，进程挂住。

改用jenkins1.589.war测试,需要SDK 1.6 ok

jenkins1.651, jeknins 2.1 需要JDK 8
sudo update-java-alternatives -s java-1.6.0-openjdk-amd64
sudo update-java-alternatives -l
切换JDK

BUILD_ID=dontKillMe在 jenkins1.651和jenkins2.1上都不能奏效。

[jenkins issues](https://issues.jenkins-ci.org/browse/JENKINS-34585?filter=-4)

http://notepad.cc/hujb2000 共享写字板notepadcc

http://notepad.cc/hujb2000 共享写字板
http://ci-dev.hz.netease.com/job/shibin_webhook_git4u/configure

SCM: H/3 * * * *


* CI上测试

http://ci.hz.netease.com/computer/new
节点名称 ： hujb-icp-0.0.1
Dumb Slave

http://ci.hz.netease.com/computer/hujb-icp-0.0.1/

Launch： 生成一个launch 脚本:slave-agent.jnlp  ,jni方式运行

java -jar slave.jar -jnlpUrl http://ci.hz.netease.com/computer/hujb-icp-0.0.1/slave-agent.jnlp -secret c77f2fef41946794d8de1b69bbb792168be9dc57f2f2a0cc872b9198bd7821a7


需要安装jdk 17以下，安装java-8-oracle
java -jar slave.jar -jnlpUrl http://218.205.113.98:8080/computer/ala/slave-agent.jnlp -secret f82f327c607f94e060f7bdb603f4b8a14fc93e8c8a1202d79928e5cb17a0cf2b

Webhook Service, service/ Github plugin
Jenkins(Github Plugin)
http://218.205.113.98:8080/github-webhook/

Remember me: Restrict where this project can be run
Label Expression: hujb-icp-0.0.1

新建:item名称：icp-dev,   构建一个自由风格的软件项目

新建子节点： hujb-icp-0.0.1机器名字， 远程工作目录 /Users/hujiabao/jenkins   ,用法：尽可能的使用这个节点，启动方法：Launch slave agents via Java Web Start

start.sh

VERSION=$1
echo $VERSION
nohup docker run --restart=always  -d --name icp2 -p 8899:8899 -e CONFIG_URL="http://static.hzspeed.cn/abc/configicpfc.json" -e PORT=8899 -e ENV=TEST hub.c.163.com/hujb2000/icp:$VERSION &


*

	#docker rm -f icp2
	docker build -t hub.c.163.com/hujb2000/icp:0.0.33 .
	docker push hub.c.163.com/hujb2000/icp:0.0.33
	sh start.sh 0.0.33
	echo $?
	docker exec icp2 /bin/bash /usr/src/app/test.sh
	echo $?

	foo=$(git show --name-only)
	echo $foo
	echo "${GIT_BRANCH}"

	echo "${GIT_URL}"

	echo "${GIT_COMMIT}"

	echo "${GIT_COMMITTER_EMAIL}"

	echo "${GIT_COMMITTER_NAME}"

	echo "${GIT_AUTHOR_EMAIL}"

	echo "${GIT_AUTHOR_NAME}"

	echo "${GIT_USER}"

	#Native Cloud App Start Entry, Need jenkins plugins or shell scritp

awk 小型的编程语言，专门处理文本

、、、
	msg='release:0.0.34'
	action=`echo $msg|awk -F':' '{print $1}'`
	version=`echo $msg|awk -F':' '{print $2}'`
	if [ $action = 'release' ]; then
	    echo $msg
	    echo $action
	    echo $version
	else
	    echo '1'
	fi

构建后操作：
  Editable Email Notification:
  Add trigger:
Default: [${BUILD_STATUS}]${JOB_NAME} Build #${BUILD_NUMBER}
Default Content:

、、、

		$DEFAULT_CONTENT

		<b>Job URL</b><br/>
		<a href="$${BUILD_URL}">${BUILD_URL}</a><br/>
		<br/>
		<b>Branch</b><br/>
		${GIT_BRANCH}<br/>
		<br/>
		<b>Changes</b><br/>
		${CHANGES,showPaths=true,format="[%d]-[%a] %m<br/>"}<br/>
		<br/>
		$AADA
		<b>Build Cause</b><br/>
		${CAUSE}<br/>
		<br/>

projectname=`docker ps -a|awk -F' ' '{print $11}'|grep icp2`
echo $? 如果icp2不存在，输出1, 如果存在输出为 0

projectname=`docker ps -a|awk -F' ' '{print $11}'`
echo $? 始终为0

、、、

	msg='release:0.0.34'
	action=`echo $msg|awk -F':' '{print $1}'`
	version=`echo $msg|awk -F':' '{print $2}'`
	if [ $action = 'release' ]; then
	    echo $msg
	    echo $action
	    echo $version
	else
	    echo '1'
	fi

	names=`docker ps -a|awk -F' ' '{print $11}'`
	for name in $names
	   do
	     if [ $name = 'icp' ]; then
	        echo find the name $name
	     fi
	done
	echo $names


	id=`docker ps -f name=icp3 --format {{.ID}}`
	if [ -z $id  ]; then
	        echo "empty"
	else
	        echo "not empty"
	fi
	echo $id


、、、

	id=`docker ps -f name=icp2  --format {{.ID}}`
	if [ -z $id ]; then
	    echo 'the icp2 container does not exists'
	else
		docker rm -f $id
	    echo find the id and rm  it
	fi

	docker build -t hub.c.163.com/hujb2000/icp:0.0.33 .
	docker push hub.c.163.com/hujb2000/icp:0.0.33
	nohup docker run -d --name icp2 -p 8899:8899 -e CONFIG_URL="http://static.hzspeed.cn/abc/configicpfc.json" -e PORT=8899 -e ENV=TEST hub.c.163.com/hujb2000/icp:0.0.33
	echo $?
	docker exec icp2 /bin/bash /usr/src/app/test.sh
	echo $?

	msg=$(git log --pretty=format:"%s" -1)
	action=`echo $msg|awk -F':' '{print $1}'`
	version=`echo $msg|awk -F':' '{print $2}'`
	if [ $action = 'release' ]; then
	    echo $msg
	    echo $action
	    echo $version
	else
	    echo '1'
	fi

、、、
ok

	id=`docker ps -f name=icp2  --format {{.ID}}`
	if [ -z $id ]; then
	    echo 'the icp2 container does not exists'
	else
		docker rm -f $id
	    echo find the id and rm  it
	fi

	msg=$(git log --pretty=format:"%s" -1)
	action=`echo $msg|awk -F':' '{print $1}'`
	version=`echo $msg|awk -F':' '{print $2}'`
	if [ $action = 'release' ]; then
		echo now is building the $version
		docker build -t hub.c.163.com/hujb2000/icp:$version .
	    echo now is running as daemon
	    nohup docker run -d --name icp2 -p 8899:8899 -e CONFIG_URL="http://static.hzspeed.cn/abc/configicpfc.json" -e PORT=8899 -e ENV=TEST hub.c.163.com/hujb2000/icp:$version
		echo $?
	    echo now is testing @version
	    docker exec icp2 /bin/bash /usr/src/app/test.sh
	    echo now is pushing the $version
	    docker push hub.c.163.com/hujb2000/icp:$version
	else
	    echo 'common commit,do not need to build'
	fi


```
	msg='release:0.0.34:env_changed:1'
	action=`echo $msg|awk -F':' '{print $1}'`
	version=`echo $msg|awk -F':' '{print $2}'`
	env_changed=`echo $msg|awk -F':' '{print $3}'`
	env_changed_value=`echo $msg|awk -F':' '{print $4}'`
	if [ $action = 'release' ]; then
	    echo $msg
	    echo $action
	    echo $version
	    echo $env_changed
	    echo $env_changed_value
	else
	    echo '1'
	fi

	id=`docker ps -f name=icp3 --format {{.ID}}`
	if [ -z $id  ]; then
	        echo "empty"
	else
	        echo "not empty"
	fi
	echo $id

```
	msg='release:0.0.34:0'
	action=`echo $msg|awk -F':' '{print $1}'`
	version=`echo $msg|awk -F':' '{print $2}'`
	env_changed=`echo $msg|awk -F':' '{print $3}'`
	if [ $action = 'release' ]; then
	    echo $msg
	    echo $action
	    echo $version
	    echo $env_changed
	    if [ $env_changed = 1 ]; then
	        echo env have changed
	    else
	        echo env have not changed
	    fi
	else
	    echo '1'
	fi

	id=`docker ps -f name=icp3 --format {{.ID}}`
	if [ -z $id  ]; then
	        echo "empty"
	else
	        echo "not empty"
	fi
	echo $id

```
	id=`docker ps -f name=icp2  --format {{.ID}}`
if [ -z $id ]; then
    echo 'the icp2 container does not exists'
else
	docker rm -f $id
    echo find the id and rm  it
fi

msg=$(git log --pretty=format:"%s" -1)
action=`echo $msg|awk -F':' '{print $1}'`
version=`echo $msg|awk -F':' '{print $2}'`
env_changed=`echo $msg|akw -F':' '{print $3}'`
if [ $action = 'release' ]; then
	echo now is building the $version
	docker build -t hub.c.163.com/hujb2000/icp:$version .
    echo now is running as daemon
    nohup docker run -d --name icp2 -p 8899:8899 -e CONFIG_URL="http://static.hzspeed.cn/abc/configicpfc.json" -e PORT=8899 -e ENV=TEST hub.c.163.com/hujb2000/icp:$version
	echo $?
    echo now is testing @version
    docker exec icp2 /bin/bash /usr/src/app/test.sh
    echo now is pushing the $version
    docker push hub.c.163.com/hujb2000/icp:$version
    if [ $env_changed = 0 ]; then
	   echo env have not changed
       echo restart icp2
       curl https://open.c.163.com/api/v1/hooks/app/5a560695727647cbb0a10eceb4964a40
       echo restart icp4
       curl https://open.c.163.com/api/v1/hooks/app/54e5fbfb1bc0492288abe6c98b7c2122
    else
       echo env have changed
       echo can not auto trigger to publish online, let developer sync the enviroment manually first
    fi
else
    echo 'common commit,do not need to build'
fi

# CI Workflow

step 1.

1. build a image based on the commit message
2. run a container by the image
3. run the backgroud test
4. run the browser test
5. push the image to cloud registry
6. run a produce cluster by the cloud image
7. run the backgroud test for cluster
8. run the broser test for cluster

step 1,2,3
```

	id=`docker ps -a -f name=icp2  --format {{.ID}}`
	if [ -z $id ]; then
	    echo 'the icp2 container does not exists'
	else
		docker rm -f $id
	    echo find the id and rm  it
	fi

	msg=$(git log --pretty=format:"%s" -1)
	action=`echo $msg|awk -F':' '{print $1}'`
	version=`echo $msg|awk -F':' '{print $2}'`
	if [ -f plugins/version.txt ]; then
		rm plugins/version.txt
	fi
	echo $version >> plugins/version.txt
	if [ $action = 'release' ]; then
		echo now is building the $version
		docker build -t hub.c.163.com/hujb2000/icp:$version .
	    echo now is running as daemon
	    nohup docker run -d --name icp2 -p 8899:8899 -e CONFIG_URL="http://static.hzspeed.cn/abc/configicpfc.json" -e PORT=8899 -e ENV=TEST hub.c.163.com/hujb2000/icp:$version
		echo $?
	    echo now is testing @version
	    docker exec icp2 /bin/bash /usr/src/app/test.sh
	    echo now is pushing the $version
	    docker push hub.c.163.com/hujb2000/icp:$version
	    echo restart icp2
	    curl https://open.c.163.com/api/v1/hooks/app/5a560695727647cbb0a10eceb4964a40
	    echo restart icp4
	    curl https://open.c.163.com/api/v1/hooks/app/54e5fbfb1bc0492288abe6c98b7c2122
	else
	    echo 'common commit,do not need to build'
	fi

step 4.
Restrict where this project can be run
hjbmac

```
	python add_new_web_site_test.py
	echo $?
	echo ok

step 5.6,

step 7.8

	msg=$(git log --pretty=format:"%s" -1)
	action=`echo $msg|awk -F':' '{print $1}'`
	version=`echo $msg|awk -F':' '{print $2}'`
	if [ -f plugins/version.txt ]; then
		rm plugins/version.txt
	fi
	echo $version >> plugins/version.txt
	if [ $action = 'release' ]; then
		echo now is pushing the $version
	    docker push hub.c.163.com/hujb2000/icp:$version
	    echo restart icp2
	    curl https://open.c.163.com/api/v1/hooks/app/5a560695727647cbb0a10eceb4964a40
	    echo restart icp4
	    curl https://open.c.163.com/api/v1/hooks/app/54e5fbfb1bc0492288abe6c98b7c2122
	else
	    echo 'common commit,do not need to build'
	fi

a=`curl http://icp.hzspeed.cn/version.txt`
echo $a

/bin/diff a.txt b.txt 比较就行了


、、、
#!/bin/bash
timestampt=`date +%Y%m%d%H%M%S%3N`
echo "##### timestampt: $timestampt"

echo -e "\n\n##### 随机分配eagle_int,eagle_ext,mock_server服务器的端口号"
eagle_int_deploy_port=`shuf -i 2000-65000 -n 1`
eagle_ext_deploy_port=`shuf -i 2000-65000 -n 1`
eagle_mock_scheduler_port=`shuf -i 2000-65000 -n 1`
echo -e "##### eagle_int部署的端口号为:$eagle_int_deploy_port"
echo -e "##### eagle_ext部署的端口号为:$eagle_ext_deploy_port"
echo -e "##### eagle_mock_scheduler部署的端口号为:$eagle_mock_scheduler_port"


echo -e "\n\n############# 第一步：部署mock server，mock掉后台的调度器+jenkins(master分支)"
echo "########################################################################"
cd ./../mock_scheduler_master
git clone ssh://git@mock_scheduler/eagle_eye/mock_scheduler.git $timestampt && cd $timestampt
docker run -dit -p $eagle_mock_scheduler_port:3000 -w /home/qadev/ -v $(pwd):/home/qadev --name eagleeye_mock_$timestampt registry.hz.netease.com/qadev/eagleeye-mock-base:latest /bin/bash
docker exec -i eagleeye_mock_$timestampt /bin/bash  -c 'passenger start -e production -b 0.0.0.0 -d'
eagle_mock_container_ip=`docker inspect --format '{{ .NetworkSettings.IPAddress }}' eagleeye_mock_$timestampt`


echo -e "\n\n############# 第二步：部署对外的服务(默认部署当前分支)"
echo "########################################################################"
cd $WORKSPACE
echo "##### 当前分支：$CURRENT_BRANCH"
echo "##### 拉取当前分支到一个随机子目录:$timestamp"
if [ -z "$CURRENT_BRANCH" ]
then
    echo "##### 当前分支信息不对，转为部署develop分支"
    git clone -b develop ssh://git@extweb/eagle_eye/extweb.git $timestampt
else
    git clone -b $CURRENT_BRANCH ssh://git@extweb/eagle_eye/extweb.git $timestampt
fi
cd $timestampt
cp /home/qadev/projects/ui/database-ui-ext.yml config/database.yml
cp /home/qadev/projects/extweb/secrets.yml config/
cp /home/qadev/projects/session_store.rb config/initializers/session_store.rb    # session_store.rb
MockServer="API_ADDR = 'http://$eagle_mock_container_ip:3000'"
sed -ie "s#.*API_ADDR =.*#$MockServer#g" config/environment.rb  #指向Mock Server,而不是Scheduler
sed -ie "s/auth-liantiao.c.163.com/auth-yanlian.c.163.com/g" config/environment.rb  #按照梦玲说的修改这个域名指向
echo "##### 启动extweb容器"
docker run -dit -p $eagle_ext_deploy_port:3000 -w /home/qadev/ -v $(pwd):/home/qadev --name eagleeye_ext_$timestampt registry.hz.netease.com/qadev/eagleeye-ext-resign:latest /bin/bash
echo "##### 设置云账号host映射"
docker exec -i eagleeye_ext_$timestampt /bin/bash -c "echo '115.236.124.25 auth-yanlian.c.163.com' >> /etc/hosts"
echo "##### 执行bundle install"
docker exec -i eagleeye_ext_$timestampt /bin/bash -c 'bundle install'
docker exec -i eagleeye_ext_$timestampt /bin/bash -c 'bundle update yua'
docker exec -i eagleeye_ext_$timestampt /bin/bash -c 'rake db:drop RAILS_ENV=production'
docker exec -i eagleeye_ext_$timestampt /bin/bash -c 'rake db:create RAILS_ENV=production'
docker exec -i eagleeye_ext_$timestampt /bin/bash -c 'rake db:migrate RAILS_ENV=production'
docker exec -i eagleeye_ext_$timestampt /bin/bash -c 'rake db:seed RAILS_ENV=production'
docker exec -i eagleeye_ext_$timestampt /bin/bash -c 'rails runner script/add_init_ui_test_data.rb -e production'
echo "##### 启动passenger..."
docker exec -i eagleeye_ext_$timestampt /bin/bash -c 'passenger start -e production -b 0.0.0.0 -d'
for ((i=1;i<=5;i++)); do docker run --rm -v $(pwd):/home/qadev registry.hz.netease.com/qadev/mcss:latest /home/qadev/app/assets/stylesheets/mcss/index.mcss -o /home/qadev/app/assets/stylesheets/index.css; done
docker exec -i eagleeye_ext_$timestampt /bin/bash -c  'RAILS_ENV=production rake assets:precompile'
docker exec -i eagleeye_ext_$timestampt /bin/bash -c 'touch tmp/restart.txt'
sleep 10s
eagle_ext_deploy_container_ip=`docker inspect --format '{{ .NetworkSettings.IPAddress }}' eagleeye_ext_$timestampt`
echo "##### extweb服务部署完成，分支为$CURRENT_BRANCH"

echo -e "\n\n############# 第三步：部署对内的服务(部署develop分支)"
echo "########################################################################"
echo "##### 配置intweb容器develop分支"
cd ./../../intweb-develop
git clone -b develop ssh://git@intweb/eagle_eye/intweb.git $timestampt
cd $timestampt
cp /home/qadev/projects/ui/database-ui-ext.yml config/database.yml
cp /home/qadev/projects/intweb/secrets.yml config/
cp /home/qadev/projects/session_store.rb config/initializers/session_store.rb    # session_store.rb
cp /home/qadev/projects/ui/production.rb config/environments/production.rb #邮箱配置
cp /home/qadev/projects/ui/user_mailer.rb app/mailers/user_mailer.rb  #邮箱配置
MockServer="API_ADDR = 'http://$eagle_mock_container_ip:3000'"
sed -ie "s#.*API_ADDR =.*#$MockServer#g" config/environment.rb  #指向Mock Server,而不是Scheduler
sed -ie "s/auth-liantiao.c.163.com/auth-yanlian.c.163.com/g" config/environment.rb  #按照梦玲说的修改这个域名指向
ExtServer="EXT_RESULT_URL = 'http://$eagle_ext_deploy_container_ip:3000/'"
sed -it "s#.*EXT_RESULT_URL = .*#$ExtServer#g" config/environment.rb #提交报告后跳转到对外结果详情页面

echo "##### 启动intweb容器的develop分支"
docker run -dit -p $eagle_int_deploy_port:3000 -w /home/qadev/ -v $(pwd):/home/qadev --name eagleeye_int_$timestampt registry.hz.netease.com/qadev/eagleeye-int-resign:latest /bin/bash
docker exec -i eagleeye_int_$timestampt /bin/bash -c "echo '115.236.124.25 auth-yanlian.c.163.com' >> /etc/hosts"
docker exec -i eagleeye_int_$timestampt /bin/bash -c 'bundle install'
docker exec -i eagleeye_int_$timestampt /bin/bash -c 'bundle update yua'
for ((i=1;i<=5;i++)); do docker run --rm -v $(pwd):/home/qadev registry.hz.netease.com/qadev/mcss:latest /home/qadev/app/assets/stylesheets/mcss/index.mcss -o /home/qadev/app/assets/stylesheets/index.css; done
docker exec -i eagleeye_int_$timestampt /bin/bash -c 'RAILS_ENV=production rake assets:precompile'
docker exec -i eagleeye_int_$timestampt /bin/bash -c 'passenger start -e production -b 0.0.0.0 -d'
sleep 10s
echo "##### intweb服务部署完成，分支为develop"


echo -e "\n\n############# 第四步：传参给下游的UI Job"
echo "########################################################################"
echo "##### 获取对内int，对外ext容器各自的ip传给下游UI Job"
eagle_int_develop_container_ip=`docker inspect --format '{{ .NetworkSettings.IPAddress }}' eagleeye_int_$timestampt`
echo "##### 准备传递参数给下游的EagleEye-UI Job"
cd $WORKSPACE
if [ -f eagle_ext_property.txt ]; then
  echo "删除eagle_ext_property.txt文件"
  rm eagle_ext_property.txt
fi
echo "eagle_ext_container_ip=$eagle_ext_deploy_container_ip" >> eagle_ext_property.txt
echo "eagle_int_container_ip=$eagle_int_develop_container_ip" >> eagle_ext_property.txt
echo "eagle_mock_container_ip=$eagle_mock_container_ip" >> eagle_ext_property.txt
echo "timestampt=$timestampt" >> eagle_ext_property.txt
cat eagle_ext_property.txt

echo -e "\n\n############# 第五步：修改mockserver的配置并重启mockserver"
echo "########################################################################"
cd $WORKSPACE/./../mock_scheduler_master/$timestampt
eagle_host="  eagle_host: "$eagle_int_develop_container_ip #ymal格式要求很严，别忘了前面两个空格
sed -ie "s#.*eagle_host:.*#$eagle_host#g" config/config.yml
docker exec -i eagleeye_mock_$timestampt /bin/bash  -c 'passenger stop;passenger start -e production -b 0.0.0.0 -d'

echo -e "\n\n############# 第六步：判断部署成功与否"
echo "########################################################################"
# 有时候由于代码的原因，部署会失败，这种情况下没必要跑下游的Job了，直接发告警
int_ret_msg=`curl -I -s -L http://$eagle_int_develop_container_ip:$eagle_int_deploy_port | grep "HTTP/1.1"`
ext_ret_msg=`curl -I -s -L http://$eagle_ext_deploy_container_ip:$eagle_ext_deploy_port | grep "HTTP/1.1"`
mock_ret_msg=`curl -I -s -L http://$eagle_mock_container_ip:$eagle_mock_scheduler_port | grep "HTTP/1.1"`
if [[ $int_ret_msg =~ "500 Internal Server Error" ]] ||
   [[ $ext_ret_msg =~ "500 Internal Server Error" ]] ||
   [[ $mock_ret_msg =~ "500 Internal Server Error" ]]; then
  echo "##### 代码部署不成功，忽略下游的UI"
  echo "##### 停止本次执行所生成的相关容器"
  docker stop eagleeye_ext_$timestampt
  docker stop eagleeye_int_$timestampt
  docker stop eagleeye_mock_$timestampt
  exit 1
fi



predefined parameter

key=$key
PRODUCT=$PRODUCT
MODULE=$MODULE
VERSION=$VERSION
jobName=$JOB_NAME
buildNum=$BUILD_NUMBER


、、、
#git clone项目代码库
if [ ! -d azkaban-plugins-3.0 ]
    then  git clone ssh://git@g.hz.netease.com:22222/bigdata/azkaban-plugins-3.0.git
    else  cd azkaban-plugins-3.0
          git pull
          cd ..
fi

#git clone可视化平台脚本/工具代码库
if [ ! -d data_collect_ci ]
    then  git clone ssh://hzzengxianghui@git.hz.netease.com:22222/hznizhifeng/data_collect_ci.git
    else  cd azkaban-plugins-3.0
          git pull
          cd ..
fi
#进入项目根目录
cd azkaban-plugins-3.0
echo $VERSION
#切换分支
git checkout develop
#统计代码总行数、注释行数、空行数
python ../data_collect_ci/codecount.py
#统计代码变更行数
python ../data_collect_ci/gitinspector-zni-modified/gitinspector.py
#编译项目，CKJM是对编译后的.class文件进行分析
ant package
#回到上级目录
cd ..
#统计类调用、继承关系
find azkaban-plugins-3.0 -name '*.class' | java -jar ./data_collect_ci/ckjm-zni-modified/build/ckjm-zni-modified.jar > metrics.txt
python data_collect_ci/ckjm_result_parse.py
#统计方法数、复杂度
./data_collect_ci/javancss-32.53/bin/javancss -object -recursive azkaban-plugins-3.0 -out javancss_output_class.txt
./data_collect_ci/javancss-32.53/bin/javancss -function -recursive azkaban-plugins-3.0 -out javancss_output_method.txt
python data_collect_ci/javancss_result_parse.py


‘’‘
#git clone项目代码库
if [ ! -d mammut ]
    then  git clone ssh://git@g.hz.netease.com:22222/bigdata/mammut.git
    else  cd mammut
          git pull
          cd ..
fi

#git clone可视化平台脚本/工具代码库
if [ ! -d data_collect_ci ]
    then  git clone ssh://hzzengxianghui@git.hz.netease.com:22222/hznizhifeng/data_collect_ci.git
    else  cd mammut
          git pull
          cd ..
fi
#进入项目根目录
cd mammut
echo $VERSION
#切换分支
git checkout m13
#统计代码总行数、注释行数、空行数
python ../data_collect_ci/codecount.py
#统计代码变更行数
python ../data_collect_ci/gitinspector-zni-modified/gitinspector.py
#编译项目，CKJM是对编译后的.class文件进行分析
/home/ds/apache-maven/bin/mvn clean install -Dmaven.skip.test=true
#回到上级目录
cd ..
#统计类调用、继承关系
find mammut -name '*.class' | java -jar ./data_collect_ci/ckjm-zni-modified/build/ckjm-zni-modified.jar > metrics.txt
python data_collect_ci/ckjm_result_parse.py
#统计方法数、复杂度
./data_collect_ci/javancss-32.53/bin/javancss -object -recursive mammut -out javancss_output_class.txt
./data_collect_ci/javancss-32.53/bin/javancss -function -recursive mammut -out javancss_output_method.txt
python data_collect_ci/javancss_result_parse.py

···
git clone ssh://git@g.hz.netease.com:22222/bigdata/mammut.git
export MAVEN_HOME=/home/ds/apache-maven
export M2_HOME=/home/ds/apache-maven
/home/ds/apache-maven/bin/mvn clean install

···
# required metadata
sonar.projectKey=com.netease.mammut.datastream
sonar.projectName=Datastream
sonar.projectVersion=1.0

# path to the parent source code directories (required)
sonar.sources=src

# List of the module identifiers
sonar.modules=module1,module2,module3,module4,module5,module6,module7,module8,module9

# Project base directory has to be overriden for each module
module1.sonar.projectBaseDir=api
module2.sonar.projectBaseDir=client
module3.sonar.projectBaseDir=tool
module4.sonar.projectBaseDir=datastream2
module5.sonar.projectBaseDir=flume
module6.sonar.projectBaseDir=flume-extra
module7.sonar.projectBaseDir=meta
module8.sonar.projectBaseDir=sinkPlugin
module9.sonar.projectBaseDir=server

# Overrides some parent properties for modules
module1.sonar.sources=management-dao,management-service,monitor-dao
module1.sonar.projectName=api
module2.sonar.sources=dbcollector,ds-socket,tailfile-agent
module2.sonar.projectName=client
module3.sonar.sources=aspectj,daosupport,datastream-syslog,datastream-util,fsqueue,hbase-client-0.92,hbase-client-0.94,hbase-util,hdfsClientSupportKerberos,heartbeat,mongo-handler,rabbitmq,statistics,tungsten-dev,zeromq-rpc,zk-manager,zk-util
module3.sonar.projectName=tool
module4.sonar.sources=ds-client,ds-monitor,ds-server
module4.sonar.projectName=datastream2
module5.sonar.sources=bin,conf,docs
module5.sonar.projectName=flume
module6.sonar.sources=ackSyslogTcp,datastream-sink,fieldParser,hadoopProxy-server,hbaseProxy-client,sink-common
module6.sonar.projectName=flume-extra
module7.sonar.sources=src
module7.sonar.projectName=meta
module8.sonar.sources=src
module8.sonar.projectName=sinkPlugin
module9.sonar.sources=datastream-watchdog,hadoopv2-hbaseProxyServerLoader,hadoopv2-hdfsProxyServerLoader,management-server,mongo-queryServer
module9.sonar.projectName=server

# path to project binaries (optional), for example directory of Java bytecode
#sonar.binaries=bin

# Uncomment this line to analyse a project which is not a java project.
# The value of the property must be the key of the language.
sonar.language=java

、、、
#!/bin/bash

timestamp=`date +%Y%m%d%H%M%S`
echo "##### 从Git服务器拉取代码到一个随机子目录:$timestamp..."
git clone ssh://git@omtl/qadev/omtl.git $timestamp
cd $timestamp

echo "##### 随机分配qbs,omtl的端口号..."
qbs_port=`shuf -i 2000-65000 -n 1`
qbs_ssh_port=`shuf -i 2000-65000 -n 1`
omtl_port=`shuf -i 2000-65000 -n 1`
mysql_port=`shuf -i 2000-65000 -n 1`

echo -e "qbs端口号:$qbs_port;\nqbs ssh端口号:$qbs_ssh_port; \nomtl端口号:$omtl_port; \nmysql数据库端口号:$mysql_port;"

echo "##### 从docker起qbs环境,端口号为$qbs_port,ssh端口号为$qbs_ssh_port,qbs容器ID为:"
docker run -d -p $qbs_port:3005 -p $qbs_ssh_port:22 --name qbs-standalone-$timestamp qbs-stanalone:latest

echo "##### 从mysqldump文件中起一个cloudberry_qa7_dev数据库容器,mysql容器ID为:"
cp ~/mysql/cloudberry_qa7_dev_mysqldump.mysql /tmp/cloudberry_qa7_dev_mysqldump$timestamp.mysql
docker run -d -p $mysql_port:3306 -v /tmp:/tmp -e MYSQL_PASS="admin" -e STARTUP_SQL="/tmp/cloudberry_qa7_dev_mysqldump$timestamp.mysql" --name cloudberry-mysql-$timestamp tutum/mysql:5.5

echo "##### 从网易蜂巢拉取mcss镜像并预编译mcss..."
#docker pull registry.hz.netease.com/qadev/mcss
#docker tag registry.hz.netease.com/qadev/mcss:latest mcss:latest
rm -rf ./app/assets/stylesheets/index.css
docker run --rm -v $(pwd):/qadev/omtl mcss:latest /qadev/omtl/app/mcss/index.mcss -o /qadev/omtl/app/assets/stylesheets/index.css

echo "##### 拷贝rails可执行命令..."
cp -r ~/config/omtl/bin/ ./

echo "##### 动态替换database.yml以及端口号..."
cp ~/config/omtl/database.yml config/database.yml
mysql_container_ip=`docker inspect --format '{{ .NetworkSettings.IPAddress }}' cloudberry-mysql-$timestamp`

echo "##### 从网易蜂巢拉取omtl镜像并部署omtl环境..."
#docker pull registry.hz.netease.com/qadev/omtl
#docker tag registry.hz.netease.com/qadev/omtl:latest omtl:latest

echo "##### 动态替换application_helper.rb【短期绕过openid登陆的方法】..."
cp ~/config/omtl/application_helper.rb  ./app/helpers/
echo "##### 动态替换database.yml..."
sed -ie s/HOST/$mysql_container_ip/g config/database.yml

echo "##### 启动omtl Docker服务，容器ID为:"
docker run -d -p $omtl_port:3000 -v $(pwd):/home/root/omtl --name omtl-$timestamp omtl-base:latest
sleep 30s

echo "##### 获取omtl部署环境的ip..."
omtl_container_ip=`docker inspect --format '{{ .NetworkSettings.IPAddress }}' omtl-$timestamp`
echo -e "##### omtl测试环境容器启动成功，办公网地址(需要cloud VPN)：http://10.165.124.143:$omtl_port \n Docker容器地址: $omtl_container_ip:3000"

echo "##### 传递参数给下游的UI Job..."
cd ..
if [ -f omtl_property.txt ]; then
  echo "##### 先删除omtl_property.txt文件..."
  rm omtl_property.txt
fi
echo "omtl_container_ip=$omtl_container_ip" >> omtl_property.txt
echo "omtl_container_port=$omtl_port" >> omtl_property.txt
echo "timestamp=$timestamp" >> omtl_property.txt
cat omtl_property.txt

···
#!/bin/bash
# 判断部署是否成功，有时候由于代码的原因，部署会失败，这种情况下没必要跑下游的UI Job了，直接发告警
ret_msg=`curl -I -s -L http://127.0.0.1:$omtl_container_port | grep "HTTP/1.1"`
if [[ $ret_msg =~ "500 Internal Server Error" ]];  then
  echo "##### 代码部署不成功，忽略下游的UI..."
  echo "##### 停止本次执行所生成的相关容器..."
  docker stop cloudberry-mysql-$timestamp
  docker stop qbs-standalone-$timestamp
  docker stop omtl-$timestamp
  exit 1
fi



···

#!/bin/bash +x
export BUILD_ID=dontKillMe

echo "##### 从Git服务器拉取UI代码到一个随机子目录:$timestamp..."
mkdir $timestamp
git clone -b for_docker ssh://hzchenshibin@git.hz.netease.com:22222/wb.xcq/omtl_ui.git $timestamp && cd $timestamp

echo "##### 随机分配omtl_ui Docker容器的vnc/ssh端口号..."
omtl_ui_port=`shuf -i 2000-65000 -n 1`
omtl_ui_ssh_port=`shuf -i 2000-65000 -n 1`
echo -e "##### omtl_ui容器vnc端口号:$omtl_ui_port..."
echo -e "##### omtl_ui容器的ssh端口号:$omtl_ui_ssh_port..."

echo "##### 动态替换Parameters.java文件以及所需的jar包等文件..."
cp ~/config/omtl_ui/Parameters.java src/com/netease/omtl/account/
sed -ie s/OMTL_HOST/$omtl_container_ip/g src/com/netease/omtl/account/Parameters.java
cp ~/config/tc/chromedriver res/
cp ~/config/tc/*.jar lib/

echo "##### 从网易蜂巢拉取omtl-ui测试镜像【是否每次都需要，待商榷】..."
#docker pull registry.hz.netease.com/qadev/omtl-ui
echo "##### 重命名镜像..."
#docker tag registry.hz.netease.com/qadev/omtl-ui:latest omtl-ui:latest

echo "##### Docker起omtl-ui容器,容器的vnc端口号为:$tc_ui_port,ssh端口号:$tc_ui_ssh_port..."
docker run --privileged -d -p $omtl_ui_port:5900 -p $omtl_ui_ssh_port:22 -v $(pwd):/home/qadev/omtl_ui -v /home/qadev/.m2:/home/qadev/.m2 --name omtl_ui-$timestamp omtl_ui:latest
sleep 15s

echo "##### 执行Maven命令跑ui自动化..."
#mv ~/.ssh/known_hosts ~/.ssh/known_hosts.bak
export LC_ALL=C.UTF-8
sshpass -p qadev ssh -p $omtl_ui_ssh_port qadev@127.0.0.1 "export LANG=C.UTF-8 && export LC_CTYPE=C.UTF-8 && export JAVA_HOME=/usr/java && export DISPLAY=:1 && /usr/maven/bin/mvn test -f /home/qadev/omtl_ui/pom.xml"

···

#!/bin/bash

echo -e "\n\n##### 随机分配qbs,tc,mysql数据库的端口号"
timestampt=`date +%Y%m%d%H%M%S%3N`
qbs_port=`shuf -i 2000-65000 -n 1`
qbs_ssh_port=`shuf -i 2000-65000 -n 1`
tc_port=`shuf -i 2000-65000 -n 1`
mysql_port=`shuf -i 2000-65000 -n 1`
echo -e "##### qbs部署的端口号为:$qbs_port"
echo -e "##### qbs-ssh部署的端口号为:$qbs_ssh_port"
echo -e "##### mysql部署的端口号为:$mysql_port"
echo -e "##### 本轮测试的timestampt为:$timestampt"
echo -e "##### tc部署的端口号为:$tc_port"

echo "##### 当前分支：$CURRENT_BRANCH..."
echo "##### 拉取当前分支到一个随机子目录:$timestampt"
mkdir $timestampt
if [ -z "$CURRENT_BRANCH" ] || [ $CURRENT_BRANCH == '${gitlabSourceBranch}' ]
then
    echo "##### 当前分支信息不对，转为部署develop分支"
    git clone -b develop ssh://tc/qadev/tc.git $timestampt
else
    git clone -b $CURRENT_BRANCH ssh://tc/qadev/tc.git $timestampt
fi

echo -e "\n\n############# 第一步：部署qbs服务"
echo "########################################################################"
#docker run -it -p 2999:3000 -w /home/tc -v $(pwd):/home/tc --name tc_deploy_qbs registry.hz.netease.com/qadev/tc-base-python:latest /bin/bash(首次run的命令)
cd $WORKSPACE/../tc_deploy_qbs
git stash && git pull origin develop && git stash pop
cp ~/config/tc/tc_qbs_database.yml config/database.yml #使用qa7的tc_deploy_qbs数据库
docker exec -i tc_deploy_qbs /bin/bash -c 'passenger stop'
docker exec -i tc_deploy_qbs /bin/bash -c 'bundle install --without production'
docker exec -i tc_deploy_qbs /bin/bash -c 'rake db:drop RAILS_ENV=development'
docker exec -i tc_deploy_qbs /bin/bash -c 'rake db:create RAILS_ENV=development'
docker exec -i tc_deploy_qbs /bin/bash -c 'rake db:migrate RAILS_ENV=development'
docker exec -i tc_deploy_qbs /bin/bash -c 'rake db:seed RAILS_ENV=development'
docker exec -i tc_deploy_qbs /bin/bash -c 'passenger start -e development -b 0.0.0.0 -d'
docker exec -i tc_deploy_qbs /bin/bash -c 'touch tmp/restart.txt'

echo -e "\n\n############# 第二步：部署tc后端"
echo "########################################################################"
cd $WORKSPACE/$timestampt
cp ~/config/tc/accounts_controller.rb  ./app/controllers/ #【短期绕过openid登陆的方法】
cp ~/config/tc/database_ci_deploy.yml config/database.yml
cp ~/config/tc/application.rb config/application.rb

#qbs_container_ip=`docker inspect --format '{{ .NetworkSettings.IPAddress }}' tc_deploy_qbs
#sed -ie s/QBS_HOST/$qbs_container_ip/g config/application.rb

cp ~/config/tc/tc_Gemfile Gemfile
cp ~/config/tc/tc_environment.rb config/environment.rb
cp ~/config/tc/secrets.yml config/secrets.yml
cp ~/config/tc/redis.rb config/initializers/redis.rb
cp ~/config/tc/tc_seeds.rb db/seeds.rb


echo "##### 启动容器"
docker run -dit -p $tc_port:3000 -w /home/tc/ -v $(pwd):/home/tc --name tc_deploy_$timestampt registry.hz.netease.com/qadev/tc-base-python:latest /bin/bash
tc_deploy_container_ip=`docker inspect --format '{{ .NetworkSettings.IPAddress }}' tc_deploy_$timestampt`

echo "##### 启动passenger"
docker exec -i tc_deploy_$timestampt /bin/bash -c 'bundle install --without test'
docker exec -i tc_deploy_$timestampt /bin/bash -c 'rake db:drop RAILS_ENV=development'
docker exec -i tc_deploy_$timestampt /bin/bash -c 'rake db:create RAILS_ENV=development'
docker exec -i tc_deploy_$timestampt /bin/bash -c 'rake db:migrate RAILS_ENV=development'
docker exec -i tc_deploy_$timestampt /bin/bash -c 'rake db:seed RAILS_ENV=development'
docker exec -i tc_deploy_$timestampt /bin/bash -c 'passenger start -e development -b 0.0.0.0 -d'


echo -e "\n\n############# 第三步：部署tc前端"
echo "########################################################################"
cd webapp
export PATH=$PATH:~/nodejs/bin
if [ ! -d node_modules ]; then
    # bigbucket.org访问不了，安装phantomjs出错，暂时通过nos中转
    #PHANTOMJS_CDNURL=http://nos.netease.com/omtl-test npm install phantomjs
    #npm install && npm install regular-state || echo "npm install completed"
    ln -s ~/config/tc/node_modules/ node_modules #用软连接不用每次都安装依赖包
fi
./node_modules/gulp/bin/gulp.js client-ui-test || echo "gulp completed"


echo "##### 准备传递参数给下游的UI Job"
cd $WORKSPACE
if [ -f tc_property.txt ]; then
  echo "删除tc_property.txt文件"
  rm tc_property.txt
fi

echo "tc_container_ip=$tc_deploy_container_ip" >> tc_property.txt
echo "timestampt=$timestampt" >> tc_property.txt
cat tc_property.txt

···

#!/bin/bash +x
export BUILD_ID=dontKillMe

echo "##### 从Git服务器拉取tc UI代码到一个随机子目录:$timestamp..."
mkdir $timestampt
git clone -b master ssh://wb.houdl@tcui/wb.houdl/tc_ui_test.git $timestampt && cd $timestampt

echo "##### 随机分配tc_ui Docker容器的vnc/ssh端口号..."
tc_ui_port=`shuf -i 2000-65000 -n 1`
tc_ui_ssh_port=`shuf -i 2000-65000 -n 1`
echo -e "##### tc_ui容器vnc端口号:$tc_ui_port..."
echo -e "##### tc_ui容器的ssh端口号:$tc_ui_ssh_port..."

echo "##### 动态替换Parameters.java文件以及所需的jar包等文件..."
cp ~/config/tc/pom.xml .
cp ~/config/tc/prop.properties .
cp ~/config/tc/Parameters.java src/main/java/com/netease/tc/utils/
sed -ie s/TC_HOST/$tc_container_ip/g src/main/java/com/netease/tc/utils/Parameters.java
# cp ~/config/tc/chromedriver res/ 改成用firefox了
mkdir -p lib && cp ~/config/tc/*.jar lib/

echo "##### Docker起tc-ui容器,容器的vnc端口号为:$tc_ui_port,ssh端口号:$tc_ui_ssh_port..."
docker run --privileged -d -p $tc_ui_port:5900 -p $tc_ui_ssh_port:22 -v $(pwd):/home/qadev/tc_ui -v /home/qadev/.m2:/home/qadev/.m2 --name tc_ui-$timestampt registry.hz.netease.com/qadev/tc-ui:latest
sleep 15s

echo "##### 执行Maven命令跑ui自动化..."

sshpass -p qadev ssh -p $tc_ui_ssh_port qadev@127.0.0.1 "export LANG=C.UTF-8 && export LC_CTYPE=C.UTF-8 && export JAVA_HOME=/usr/java && export DISPLAY=:1 && /usr/maven/bin/mvn test -f /home/qadev/tc_ui/pom.xml"
sleep 3

’‘’
#!/bin/bash
if [ ! -f "gitinspector/gitinspector/gitinspector.py" ]; then
	wget http://114.113.202.179:8282/loc/gitinspector.zip
	unzip gitinspector.zip
        mv gitinspector-* gitinspector
	rm -rf gitinspector.zip
	cd gitinspector/gitinspector
	rm -rf terminal.py
        wget -nc http://114.113.202.179:8282/loc/terminal.py
	cd ../..
else
	echo "gitinspector already exist"
fi


if [ -z "${EXCLUDE}" ]; then
	python gitinspector/gitinspector/gitinspector.py --format=xml --since=${START} --until=${END} . > git-statistics.xml
        echo "empty"
else
	python gitinspector/gitinspector/gitinspector.py --format=xml --since=${START} --until=${END} --exclude=\"${EXCLUDE}\" . > git-statistics.xml
        echo "${EXCLUDE}"
fi

if [ -f "locinterpret.jar" ]; then
    rm -rf locinterpret.jar
    echo "removed"
fi

#wget http://114.113.202.179:8282/loc/locinterpret.jar

#java -jar locinterpret.jar ${JOB_NAME} ${START} ${END} ${EXCLUDE}


····

cd /home/qatest/jenkins/workspace/nas-javaSdk-test
echo envName=cloud-qa-ci.env > src/main/resources/conf/envName
unset M2_HOME
export MAVEN_HOME=/home/qatest/software/apache-maven-3.1.1
export PATH=$MAVEN_HOME/bin:$PATH
echo "============"
export
echo "============"
rm -r ./target
sleep 5s
cd /home/qatest/jenkins/workspace/nas-javaSdk-test

#删除pom中的依赖
sed -i '50,55d' pom.xml


#下载sdk源码
git clone ssh://hzleiyezi@nas/nas/nas-sdk-java.git
cd nas-sdk-java
git checkout origin/CI
cp -r /home/qatest/jenkins/workspace/nas-javaSdk-test/nas-sdk-java/src/main/java  /home/qatest/jenkins/workspace/nas-javaSdk-test/src/main/


cd /home/qatest/jenkins/workspace/nas-javaSdk-test
rm -rf  nas-sdk-java
mvn clean test -D suiteXmlFile=src/main/resources/xml/testall.xml




# Reliable

## Macaca
 [Macaca](http://macacajs.github.io/macaca/) Solution for Automation Test with Ease. Write End-to-End tests in Node.js and run against a Webdriver server.

npm i macaca-cli -g

reliable-master使用Docker 部署，clone, make deploy env:prod

make adduser, localhost:8080访问

slave部署: brew install pkg-config , brew install zeromq, npm install reliable-slave -g

reliable server -m 218.205.113.98:8081  -verbos

Reliable Tech Stack:  Node.js, JavaScript, MongoDB, Redis,  Docker.

# Travis CI

Travis hase two version of it: travis-ci.com private,   travis-ci.org public
It support ruby,  java, gradle, go, not open source.


# Selenium

[Selenium](http://www.seleniumhq.org/)
Selenium WebDriver is the successor of Selenium Remote Control which hase been officially deprecated.

* UI_Test
通过Selenium IDE脚本录制与回放

*  Tech Stack

 Node, Docker ,Reactor, Angular, Meteor

 * CI

 Linux X Windows

 Appium mac
 Selenium PC
 Robotium android
 STF

 * appium

 Appium is an open source, cross-platform test automation tool for native, hybrid and mobile web apps, tested on simulators (iOS, FirefoxOS), emulators (Android), and real devices (iOS, Android, FirefoxOS).

Appium is an open source test automation framework for use with native, hybrid and mobile web apps.
It drives iOS and Android apps using the WebDriver protocol.

Easy setup  process, run a test now.

```
	> brew install node      # get node.js
	> npm install -g appium  # get appium
	> npm install wd         # get appium client
	> appium &               # start appium
	> node your-appium-test.js


* Robotium

Robotium is an Android test automation framework that has full support for native and hybrid applications. Robotium makes it easy to write powerful and robust automatic black-box UI tests for Android applications. With the support of Robotium, test case developers can write function, system and user acceptance test scenarios, spanning multiple Android activities.


* STF


* node-gyp
 Node.js native addon build tool

 npm install -g node-gyp

 If you have multiple Python versions installed, you can identify which Python version node-gyp uses by setting the '--python' variable:

$ node-gyp --python /path/to/python2.7

If node-gyp is called by way of npm and you have multiple versions of Python installed, then you can set npm's 'python' config key to the appropriate value:

$ npm config set python /path/to/executable/python2.7

node-gyp configure

node-gyp build

binding.gyp


A barebons gyp file appropriate for building a node addon looks like:

```
	{
	  "targets": [
	    {
	      "target_name": "binding",
	      "sources": [ "src/binding.cc" ]
	    }
	  ]
	}



## Docker
Local run

docker run -ti --name icp_dev  -p 8900:8900 -v /home/hjb/icp/easynode-ipc:/usr/src/app --workdir=/usr/src/app/bin --env ENV=DEVELOP -e CONFIG_URL=http://apollodev.nos.netease.com/146192995136214606349336371459339304947 -e PORT=8900 hub.c.163.com/hujb2000/icp:0.0.46  ./start.sh

docker build --no-cache -t hub.c.163.com/hujb2000/icp:0.0.39 .

[Dash Docset](https://kapeli.com/docset_links)


---
---
layout: post
title:  "CI"
date:   2016-05-02 13:35:30
categories: allen.hu update
---

# Jenkins + Node.js持续集成

什么是持续集成？(Continuous Integration)

提出者Martin Fowler本人对持续集成是这样定义的:持续集成是一种软件开发实践，即团队开发成员经常集成他们的工作，通常每个成员每天至少集成一次，也就意味着每天可能会发生多次集成。每次集成都通过自动化的构建（包括编译，发布，自动化测试)来验证，从而尽快地发现集成错误。许多团队发现这个过程可以大大减少集成的问题，让团队能够更快的开发内聚的软件。

* 持续集成的核心价值在于：
1. 减少风险，减少重复过程
2. 任何时间、任何地点生成可部署的软件
3. 增强项目的可见性
4. 建立团队对开发产品的信心

* 持续集成的原则
1. 所有的开发人员需要在本地机器上做本地构建，然后再提交的版本控制库中，从而确保他们的变更不会导致持续集成失败。
2. 开发人员每天至少向版本控制库中提交一次代码。
3. 开发人员每天至少需要从版本控制库中更新一次代码到本地机器。
4. 需要有专门的集成服务器来执行集成构建,每天要执行多次构建。
5. 每次构建都要100%通过。
6. 每次构建都可以生成可发布的产品。
7. 修复失败的构建是优先级最高的事情。
8. 测试是未来，未来是测试


[Jenkins](https://jenkins.io/index.html)

Jenkins 是一个开源项目，提供了一种易于使用的持续集成系统，使开发者从繁杂的集成中解脱出来，专注于更为重要的业务逻辑实现上。同时 Jenkins 能实施监控集成中存在的错误，提供详细的日志文件和提醒功能，还能用图表的形式形象地展示项目构建的趋势和稳定性。


docker run -p 8080:8080 -p 50000:50000 -v /your/home:/var/jenkins_home jenkins

mkdir data
cat > data/log.properties <<EOF
handlers=java.util.logging.ConsoleHandler
jenkins.level=FINEST
java.util.logging.ConsoleHandler.level=FINEST
EOF


docker run --name myjenkins -u root -p 8080:8080 -p 50000:50000 --env JAVA_OPTS="-Djava.util.logging.config.file=/var/jenkins_home/log.properties" -v `pwd`:/var/jenkins_home jenkins

docker  反尔不太方便，改用直接部署

##

java -jar jenkins.war

/home/hjb/.jenkins/secrets/initialAdminPassword 设置初始密码

Create First Admin User
Username: hjb
password: jenkins
FullName: hujb
Email: hujb2000@163.com

# [杭研CI](http://ci.hz.netease.com)

## 权限配置

Jenkins采用OpenID+项目矩阵授权策略的安全方式，即采用OpenID登录，具体访问和操作任务需要再次授权。

在目前的Jenkins中有以下4种角色：

系统管理员 - 对Jenkins的有完全权限
匿名用户 - 所有来自网易OpenID的用户具有全局读，视图/任务读的权限
QA管理员 - 拥有全局读权限、节点/视图/任务的增删查改操作，QA管理员由系统管理员添加
普通用户 - 初始普通用户只有匿名用户的权限，经QA管理员添加后，对Jenkins的任务有访问或操作权限
当前的超级管理员为陈仕彬<hzchenshibin@corp.netease.com>和井诚<hzjingcheng@corp.netease.com>

Jenkin维护

## CI项目

EagleEye
1. 录制回放


# Jekins 踩过的坑

Jenkins2.1.war包

/home/hjb/.jenkins/secrets/initialAdminPassword 设置初始密码

Create First Admin User
Username: hjb
password: jenkins
FullName: hujb
Email: hujb2000@163.com

Git:
Shell:
export BUILD_ID=dontKillMe
npm install
cd plugins
webpack --config webpack.prod.config.js
cd ../bin
CONFIG_URL='http://static.hzspeed.cn/abc/configicpfc.json'  ENV=TEST  nohup babel-node --harmony main.js --debug-output=true --http.server.port=8899 --src-dirs=src --main-class=netease.icp.backend.Main --config-files=config/service.conf  --easynode.app.id=icp &
echo $?
#npm test

babel-node 加入 &，进程当Job完成时退出，没有加&时，进程挂住。

改用jenkins1.589.war测试 ok


http://notepad.cc/hujb2000 共享写字板

* CI上测试

http://ci.hz.netease.com/computer/new
节点名称 ： hujb-icp-0.0.1
Dumb Slave

http://ci.hz.netease.com/computer/hujb-icp-0.0.1/

Launch： 生成一个launch 脚本:slave-agent.jnlp  ,jni方式运行

java -jar slave.jar -jnlpUrl http://ci.hz.netease.com/computer/hujb-icp-0.0.1/slave-agent.jnlp -secret c77f2fef41946794d8de1b69bbb792168be9dc57f2f2a0cc872b9198bd7821a7


Remember me: Restrict where this project can be run
Label Expression: hujb-icp-0.0.1

新建:item名称：icp-dev,   构建一个自由风格的软件项目

新建子节点： hujb-icp-0.0.1机器名字， 远程工作目录 /Users/hujiabao/jenkins   ,用法：尽可能的使用这个节点，启动方法：Launch slave agents via Java Web Start
